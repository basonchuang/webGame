<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
        <meta charset="utf-8">
        <link rel="stylesheet" href="./css/chat.css">
        <script>
            $(function(){
                dialog = $("#dialog-createGuessNumberGame").dialog({
                    autoOpen: false,
                    height: 600,
                    width: 400,
                    modal: true,
                    buttons: {
                        "Create a Guess Number Game": addGame,
                        Cancel: function() {
                        dialog.dialog( "close" );
                        }
                    },
                    close: function() {
                        form[ 0 ].reset();
                    }
                });
                form = dialog.find( "form" ).on( "submit", function( event ) {
                    event.preventDefault();
                    addGame();
                });
                $("#createGuessNumberGame").button().on( "click", function() {
                    dialog.dialog("open");
                });
            });
        </script>
    </head>
    <body>
        <button id="createGuessNumberGame">Create Guess Number Game</button>
        <!-- 輸入有幾個回合、P值、payoff、參與人數 -->
        <div id="dialog-createGuessNumberGame" title="Create Guess Number Game">
            <form>
                <fieldset>
                <label>Period</label>
                <input id="Rid" name="Rid" type="text" value="2" class="text ui-widget-content ui-corner-all" required>
                <br>
                <label>P(Fraction of Avg.)</label>
                <input id="pValue" name="pValue" type="text" value="70%" class="text ui-widget-content ui-corner-all" required>
                <br>
                <label>Payoff</label>
                <input id="payoff" name="payoff" type="text" value="20" class="text ui-widget-content ui-corner-all" required>
                <br>
                <label>Group Size</label>
                <input id="numOfStudent" name="numOfStudent" type="text" value="30" class="text ui-widget-content ui-corner-all" required>
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>
        <br><br>
        <table>
            <label>Select the game you want to start!</label>
            <select id="gameList" name="gameList" class="text ui-widget-content ui-corner-all">
                <option></option>
            </select>
            <br>
            <button id="startGame" class="text ui-widget-content ui-corner-all">Select Game!</button>
        </table>
    </body>
    
    <script type="text/javascript">
        $(document).ready(function() {
            poll();
            addGame();
        });
        //選擇遊戲
        $(function(){
            $("#startGame").on("click",function(){
                Sid = document.getElementById("gameList").value;
                jumpToResult(Sid);
            });
        });
        function jumpToResult(Sid){
            url = "gameResult.html?Sid="+Sid;
            
            $.ajax({
                url:"./function/config.php?method=startGame",
                success: function(result){
                    window.location.href = url;
                },error:function(err){console.log(err)}
            })
        }
        //顯示遊戲列表
        function poll() {
            room = $("#gameList").text();
            if(room.trim() != "") {
                $.ajax({
                    url: "./function/ajax-server.php",
                    type: "POST",
                    data: { action: "poll", room: room },
                    success: function(r) {
                    },
                });
            }
            setTimeout(poll, 1000);
        }
        //建立遊戲
        function addGame(create = false){
            post_data = { action: "room" };
            if(create) {
                new_room = Math.floor(Math.random() * Math.floor(10000));
                post_data["new"] = new_room;
                
                alert("CREATE A NEW GAME : " + new_room);

                post_data["Sid"] = new_room;
                post_data["Rid"] = document.getElementById("Rid").value;
                post_data["pValue"] = document.getElementById("pValue").value;
                post_data["payoff"] = document.getElementById("payoff").value;
                post_data["numOfStudent"] = document.getElementById("numOfStudent").value;

                create = true;
            }
            
            $.ajax({
                url: "./function/ajax-server.php",
                type: "POST",
                data: post_data,
                success: function(r) {
                    obj = JSON.parse(r);
                    list_rooms = "";
                    for(id in obj) {
                        list_rooms += "<option value='" + obj[id] + "'>Game code : " + obj[id] + "</option>";
                    }
                    
                    $("#gameList").html(list_rooms).selectmenu("refresh", true);
                },error:function(err){console.log(err)}
            });
            dialog.dialog("close");
        }
    </script>
</html>